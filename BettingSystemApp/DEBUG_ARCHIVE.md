# Отладка проблемы с архивированием ставок

## Проблема
"Ставки успешно разархивированы, восстановлено 0 записей, хотя тестовые записи были"

## Возможные причины

### 1. Проблема с форматом CSV файла
- Поле `Draw` может быть пустым, что приводит к неправильному разбору строк
- Разделители могут быть неправильными

### 2. Проблема с кодировкой
- Файл может быть сохранен в неправильной кодировке
- Специальные символы могут быть повреждены

### 3. Проблема с разбором данных
- Неправильный формат даты
- Неправильный формат чисел

## Шаги отладки

### Шаг 1: Проверьте содержимое архивного файла
1. Откройте файл `BetsArchive.csv` в блокноте
2. Проверьте, что файл содержит:
   ```
   BetID,Team1,Team2,MatchTime,Sport,Description,Team1Win,Team2Win,Draw
   1,Реал Мадрид,Барселона,2025-01-15 20:00,Футбол,Эль Класико,2.50,2.80,3.20
   2,Манчестер Юнайтед,Ливерпуль,2025-01-16 21:00,Футбол,Северо-западное дерби,2.20,3.10,3.50
   ```

### Шаг 2: Проверьте количество строк
- В заголовке должно быть 9 полей
- Каждая строка данных должна содержать 9 полей (или 8, если Draw пустое)

### Шаг 3: Проверьте формат данных
- Даты должны быть в формате `yyyy-MM-dd HH:mm`
- Числа должны использовать точку как разделитель (например, 2.50)
- Поле Draw может быть пустым

### Шаг 4: Используйте улучшенный метод разархивирования
Обновленный код теперь:
- Проверяет `parts.Length >= 8` вместо `parts.Length == 9`
- Корректно обрабатывает пустые поля Draw
- Показывает количество обработанных строк

## Исправления в коде

### 1. Улучшенное архивирование
```csharp
string drawValue = bet.Draw.HasValue ? bet.Draw.Value.ToString() : "";
sb.AppendLine(string.Format("{0},{1},{2},{3},{4},{5},{6},{7},{8}", 
    bet.BetID, bet.Team1, bet.Team2, bet.MatchTime.ToString("yyyy-MM-dd HH:mm"), 
    bet.Sport, bet.Description, bet.Team1Win, bet.Team2Win, drawValue));
```

### 2. Улучшенное разархивирование
```csharp
if (parts.Length >= 8 && DateTime.TryParse(parts[3], out DateTime parsedDate) &&
    decimal.TryParse(parts[6], out decimal team1Win) &&
    decimal.TryParse(parts[7], out decimal team2Win))
{
    decimal? drawValue = null;
    if (parts.Length > 8 && !string.IsNullOrWhiteSpace(parts[8]) && 
        decimal.TryParse(parts[8], out decimal draw))
    {
        drawValue = draw;
    }
    // ... создание объекта Bet
}
```

## Тестирование

### 1. Создайте тестовые данные
```sql
-- Выполните test_data_simple_fixed.sql
```

### 2. Заархивируйте данные
- Войдите как admin/admin123
- Нажмите "Архивировать ставки"

### 3. Проверьте архивный файл
- Откройте BetsArchive.csv
- Убедитесь, что данные корректны

### 4. Разархивируйте данные
- Нажмите "Разархивировать ставки"
- Проверьте сообщение о количестве восстановленных записей

## Ожидаемый результат
После исправлений вы должны увидеть:
```
Ставки успешно восстановлены из архива. Обработано 5 строк, восстановлено 5 записей.
```

## Если проблема остается
1. Проверьте права доступа к файлам
2. Убедитесь, что файл не открыт в других программах
3. Проверьте кодировку файла (должна быть UTF-8)
4. Попробуйте создать новый архив после очистки данных 